#!/bin/sh

<%=
    FB::Helpers::commentify(
      'This tmpwatch cron was generated by chef. To make' +
      ' additions, see fb_tmpclean/README.md'
    )
%>
<% tmpclean = node['fb_tmpclean'].to_hash %>
<% topt = tmpclean['timestamptype'] == 'atime' ? '-u' : '-m' %>
<% remove_special_files = tmpclean['remove_special_files'] ? '-a' : '' %>

for d in /var/{cache/man,catman}/{cat?,X11R6/cat?,local/cat?}; do
    if [ -d "$d" ]; then
        /usr/sbin/tmpwatch -f <%= topt %> <%= tmpclean['default_files'] %> "$d"
    fi
done

<% tmpclean['directories'].each do |dir, time| %>
<%   excludes = [] %>
<%   tmpclean['excludes'].each do |exclude| %>
<%     excludes << "-X '#{dir}/#{exclude}'" %>
<%   end %>
<%   if time.is_a?(Hash) %>
<%     unless time['timestamptype'] && time['interval'] %>
<%       fail 'fb_tmpclean: timestamptype and interval are required keys' %>
<%     end %>
<%     timestamptype = time['timestamptype'].downcase %>
<%     valid_timestamptypes = ['atime', 'ctime', 'mtime'] %>
<%     unless valid_timestamptypes.include?(timestamptype) %>
<%       fail "fb_tmpclean: timestamptype must be one of #{valid_timestamptypes}" %>
<%     end %>
<%     time_type = timestamptype == 'atime' ? '-u' : '-m' %>
<%     time = time['interval'] %>
<%   else %>
<%     time_type = topt %>
<%   end %>
<%   opts = "#{time_type} #{time} #{remove_special_files} #{dir}" %>
/usr/sbin/tmpwatch <%= excludes.join(' ') %> -f <%= opts %>
<% end %>

<% tmpclean['extra_lines'].each do |line| %>
<%=  line %>
<% end %>
